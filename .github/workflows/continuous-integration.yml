name: Continuous Integration

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ 'main' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  statuses: write
  contents: write
  pull-requests: write

env:
  DB_HOST: "127.0.0.1"
  DB_PORT: "3306"
  DB_USER: "root"
  DB_PASSWORD: "root"
  DB_SCHEMA: "kamino-test"

jobs:
  server-unit-tests:
    name: "Server - Unit Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: server
    steps:
      - name: 🔥 Initialize MySQL
        run: sudo systemctl start mysql.service
      - name: 📌 Initialize first database
        run: |
          mysql -e 'CREATE DATABASE `${{ env.DB_SCHEMA }}`;' \
          -u${{ env.DB_USER }} -p${{ env.DB_PASSWORD }}
      - name: 🚀 Boost user
        run: |
          mysql -e "ALTER USER '${{ env.DB_USER }}'@'localhost' \
          IDENTIFIED WITH mysql_native_password BY 'root';" \
          -u${{ env.DB_USER }} -p${{ env.DB_PASSWORD }}
      - name: 🍺 Check out repository code
        uses: actions/checkout@v3
      - name: 🦑 Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
      - name: 🧶 Install Dependencies
        run: npm ci
      - name: 📦 run tests
        run: npm run test-ci
      - name: ☂️ Jest Coverage Comment
        uses: MishaKav/jest-coverage-comment@main
        if: always()
        with:
          coverage-summary-path: ./server/coverage/coverage-summary.json
          title: Server Coverage
          summary-title: Summary
          badge-title: Coverage
          hide-comment: false
          create-new-comment: false
          hide-summary: false
          junitxml-title: Test Report
          junitxml-path: ./server/junit.xml
  server-api-tests:
    name: "Server - API Tests"
    runs-on: ubuntu-latest
    needs: server-unit-tests
    defaults:
      run:
        shell: bash
        working-directory: tests/api-tests
    steps:
      - name: 🍺 Check out repository code
        uses: actions/checkout@v3
      - name: 🚂 Run Dockers
        run: docker compose up --detach --wait
      - name: 🦑 Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'
      - name: 🧶 Install Dependencies
        run: npm ci
      - name: 📦 run tests
        run: npm run test
  newrelic-notification:
    runs-on: ubuntu-latest
    name: New Relic Notification
    needs: server-api-tests
    if: github.event_name == 'push'
    steps:
      - name: ☄️ New Relic Application Deployment Marker
        uses: newrelic/deployment-marker-action@v2.4.0
        with:
          apiKey: ${{ secrets.NEW_RELIC_API_KEY }}
          guid: ${{ secrets.NEW_RELIC_DEPLOYMENT_ENTITY_GUID }}
          version: "${{ github.sha }}"
          user: "${{ github.actor }}"
          description: "${{ github.event.head_commit.message }}"
          deploymentType: "ROLLING"
  db-backup:
    runs-on: ubuntu-latest
    name: Production DB Backup
    needs: server-api-tests
    if: github.event_name == 'push'
    steps:
      - name: 🍺 Check out repository code
        uses: actions/checkout@v3
      - name: 🦑 Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: 🧶 Install Dependencies
        run: |
          cd backup-script
          npm ci
      - name: 💾 Create Backup
        run: |
          cd backup-script
          npm run backup
        env:
          DB_HOST: ${{ secrets.DB_PROD_HOST }}
          DB_PORT: ${{ secrets.DB_PROD_PORT }}
          DB_USER: ${{ secrets.DB_PROD_USER }}
          DB_PASSWORD: ${{ secrets.DB_PROD_PASSWORD }}
          DB_SCHEMA: ${{ secrets.DB_PROD_SCHEMA }}
          AZURE_ACCOUNT: ${{ secrets.AZURE_ACCOUNT }}
          AZURE_ACCOUNT_KEY: ${{ secrets.AZURE_ACCOUNT_KEY }}

name: Continuous Integration

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ 'main' ]

permissions:
  checks: write
  statuses: write
  contents: write
  pull-requests: write

jobs:
  continuous-integration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Build and Start Servers
        run: docker compose up --detach --wait
      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - name: Install newman
        run: |
          npm install -g newman
      - name: Run POSTMAN collection
        run: >
          newman run "https://api.getpostman.com/collections/${{vars.POSTMAN_COLLECTION_ID}}?apikey=${{ secrets.POSTMAN_APIKEY }}" 
          --environment "https://api.getpostman.com/environments/${{ vars.POSTMAN_ENVIRONMENT_ID }}?apikey=${{ secrets.POSTMAN_APIKEY }}" 
          --reporters cli,json --reporter-json-export test-report.json
      - name: Create Status check based on postman results
        # You may also reference the major or major.minor version
        uses: im-open/process-postman-test-results@v2.1.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          results-file: test-report.json
          report-name: 'Postman Test Result #${{ github.run_number }}'     # Default: Postman Test Results
          create-status-check: true                          # Default: true
          create-pr-comment: true                            # Default: true
          update-comment-if-one-exists: true                 # Default: true
          ignore-test-failures: false                        # Default: false
          timezone: 'america/montevideo'                     # Default: UTC
      - name: Fail if there were errors in the postman tests
        if: steps.process-postman.outputs.test-outcome == 'Failed'
        run: |
          echo "There were postman failures."
          exit 1
